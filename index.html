<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Palmdale Station B2V 2026</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #111827; -webkit-tap-highlight-color: transparent; }
        input { font-size: 16px !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        // =====================================================
        // ‚ö†Ô∏è CONFIGURATION - UPDATE THESE VALUES! ‚ö†Ô∏è
        // =====================================================
        
        // 1. Replace with your Firebase database URL (from Step 3)
        const FIREBASE_DATABASE_URL = "https://console.firebase.google.com/u/0/project/plmb2v/database/plmb2v-default-rtdb/data/~2F";
        
        // 2. Change this admin password before sharing!
        const ADMIN_PASSWORD = "buttstuff69";
        
        // =====================================================

        // Initialize Firebase
        const firebaseConfig = {
            databaseURL: FIREBASE_DATABASE_URL
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const MapPin = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>);
        const User = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const ChevronDown = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>);
        const ChevronUp = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>);
        const Edit2 = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>);
        const Check = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>);
        const X = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const Navigation = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>);
        const Lock = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>);
        const Unlock = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>);
        const Eye = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>);
        const CheckCircle = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const Clock = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>);
        const UserCheck = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>);
        const Wifi = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>);
        const WifiOff = ({ size = 24 }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>);

        const STAGES = [
            { id: 0, name: "Check-in", lat: 35.55322, lng: -116.18933, distance: 0, description: "Follow Vehicle Check-in - Highway 127, 21+ miles north of I-15" },
            { id: 1, name: "Stage 1 (Start)", lat: 35.582, lng: -116.22105, distance: 5.4, description: "Start line - 24.3 miles north of Baker on Highway 127" },
            { id: 2, name: "Stage 2", lat: 35.63272, lng: -116.29048, distance: 4.0, description: "Highway 127, about 30 miles north of Baker" },
            { id: 3, name: "Stage 3", lat: 35.68953, lng: -116.30238, distance: 4.2, description: "34 miles north of Baker near Dumont Dunes Road" },
            { id: 4, name: "Stage 4", lat: 35.74935, lng: -116.31543, distance: 5.1, description: "38 miles north of Baker, 18 miles south of Shoshone" },
            { id: 5, name: "Stage 5", lat: 35.81552, lng: -116.33015, distance: 6.1, description: "43 miles north of Baker, 13 miles south of Shoshone" },
            { id: 6, name: "Stage 6", lat: 35.87695, lng: -116.26778, distance: 6.1, description: "7 miles south of Shoshone, ~50 miles north of Baker" },
            { id: 7, name: "Stage 7", lat: 35.96145, lng: -116.2679, distance: 6.2, description: "Less than a mile south of Shoshone, 30 miles from Pahrump" },
            { id: 8, name: "Stage 8", lat: 36.00098, lng: -116.19802, distance: 6.6, description: "22 miles south of Pahrump on Highway 372/178" },
            { id: 9, name: "Stage 9", lat: 36.09523, lng: -116.18397, distance: 7.5, description: "15 miles south of Pahrump on Highway 372 - Manual timing" },
            { id: 10, name: "Stage 10", lat: 36.16825, lng: -116.10282, distance: 5.8, description: "Highway 372 approach to Pahrump" },
            { id: 11, name: "Stage 11", lat: 36.205, lng: -116.01242, distance: 5.3, description: "Highway 372 at Blagg Road, 1.5 miles south of Highway 160" },
            { id: 12, name: "Stage 12", lat: 36.17638, lng: -115.93198, distance: 4.7, description: "50 miles west of I-15 on Highway 160, 4 miles east of Pahrump" },
            { id: 13, name: "Stage 13", lat: 36.13272, lng: -115.86677, distance: 6.9, description: "8 miles east of Pahrump, 44 miles west of I-15" },
            { id: 14, name: "Stage 14", lat: 36.07305, lng: -115.76897, distance: 10.7, description: "Highway 160 at Tecopa Road - Longest stage!" },
            { id: 15, name: "Stage 15", lat: 36.00595, lng: -115.60615, distance: 6.4, description: "Mountain Pass area - 5,472ft elevation" },
            { id: 16, name: "Stage 16", lat: 36.01288, lng: -115.49937, distance: 5.8, description: "Challenging baton hand-off - tight shoulder - 5,472ft" },
            { id: 17, name: "Stage 17", lat: 36.01417, lng: -115.42355, distance: 8.3, description: "Near Late Night Trailhead on Highway 160" },
            { id: 18, name: "Stage 18", lat: 36.02083, lng: -115.28833, distance: 6.3, description: "Blue Diamond Rd at S. El Capitan Way" },
            { id: 19, name: "Stage 19", lat: 36.1046, lng: -115.2969, distance: 5.6, description: "4670 South Fort Apache Road" },
            { id: 20, name: "Stage 20", lat: 36.129, lng: -115.227, distance: 3.2, description: "Desert Inn at Jones Ave - Final running stage" },
            { id: 21, name: "Finish", lat: 36.1163, lng: -115.1872, distance: 0, description: "Rio Hotel & Casino - Finish Line in Pavilion" }
        ];

        const TOTAL_DISTANCE = STAGES.reduce((sum, s) => sum + s.distance, 0);

        function App() {
            const [runners, setRunners] = useState({});
            const [checkIns, setCheckIns] = useState({});
            const [selectedStage, setSelectedStage] = useState(null);
            const [editingStage, setEditingStage] = useState(null);
            const [editName, setEditName] = useState('');
            const [editNotes, setEditNotes] = useState('');
            const [showList, setShowList] = useState(true);
            const [loading, setLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [loginError, setLoginError] = useState('');
            const [showCheckInConfirm, setShowCheckInConfirm] = useState(null);
            const [connected, setConnected] = useState(true);
            const [dbError, setDbError] = useState(false);

            // Real-time Firebase listeners
            useEffect(() => {
                // Check if Firebase is configured
                if (FIREBASE_DATABASE_URL === "https://YOUR-PROJECT-ID.firebaseio.com") {
                    setDbError(true);
                    setLoading(false);
                    return;
                }

                // Listen for connection state
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    setConnected(snap.val() === true);
                });

                // Listen for runners data
                const runnersRef = database.ref('runners');
                runnersRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    setRunners(data || {});
                    setLoading(false);
                }, (error) => {
                    console.error('Runners error:', error);
                    setLoading(false);
                });

                // Listen for check-ins data
                const checkInsRef = database.ref('checkIns');
                checkInsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    setCheckIns(data || {});
                }, (error) => {
                    console.error('CheckIns error:', error);
                });

                // Check admin session
                if (sessionStorage.getItem('palmdale-admin') === 'true') {
                    setIsAdmin(true);
                }

                // Cleanup
                return () => {
                    connectedRef.off();
                    runnersRef.off();
                    checkInsRef.off();
                };
            }, []);

            const handleLogin = () => {
                if (passwordInput === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    sessionStorage.setItem('palmdale-admin', 'true');
                    setShowLoginModal(false);
                    setPasswordInput('');
                    setLoginError('');
                } else {
                    setLoginError('Incorrect password');
                }
            };

            const handleLogout = () => {
                setIsAdmin(false);
                sessionStorage.removeItem('palmdale-admin');
                setEditingStage(null);
            };

            const handleSaveRunner = async (stageId) => {
                try {
                    await database.ref(`runners/${stageId}`).set({
                        name: editName,
                        notes: editNotes,
                        updatedAt: new Date().toISOString()
                    });
                    setSaveStatus('Saved!');
                    setTimeout(() => setSaveStatus(''), 2000);
                } catch (error) {
                    console.error('Save error:', error);
                    setSaveStatus('Error saving');
                }
                setEditingStage(null);
                setEditName('');
                setEditNotes('');
            };

            const handleClearRunner = async (stageId) => {
                try {
                    await database.ref(`runners/${stageId}`).remove();
                    await database.ref(`checkIns/${stageId}`).remove();
                    setSaveStatus('Cleared!');
                    setTimeout(() => setSaveStatus(''), 2000);
                } catch (error) {
                    console.error('Clear error:', error);
                }
            };

            const handleCheckIn = async (stageId) => {
                try {
                    await database.ref(`checkIns/${stageId}`).set({
                        time: new Date().toISOString(),
                        runnerName: runners[stageId]?.name || 'Unknown'
                    });
                    setSaveStatus('Checked in!');
                    setTimeout(() => setSaveStatus(''), 2000);
                } catch (error) {
                    console.error('Check-in error:', error);
                    setSaveStatus('Error');
                }
                setShowCheckInConfirm(null);
            };

            const handleUndoCheckIn = async (stageId) => {
                try {
                    await database.ref(`checkIns/${stageId}`).remove();
                } catch (error) {
                    console.error('Undo error:', error);
                }
            };

            const startEdit = (stage) => {
                if (!isAdmin) return;
                setEditingStage(stage.id);
                setEditName(runners[stage.id]?.name || '');
                setEditNotes(runners[stage.id]?.notes || '');
            };

            const getStageColor = (stage) => {
                if (stage.id === 0) return '#6B7280';
                if (stage.id === 21) return '#10B981';
                if (stage.distance >= 8) return '#EF4444';
                if (stage.distance >= 6) return '#F59E0B';
                return '#3B82F6';
            };

            const formatTime = (iso) => {
                const date = new Date(iso);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const assignedCount = Object.keys(runners).filter(k => runners[k]?.name).length;
            const checkedInCount = Object.keys(checkIns).length;
            const runningStages = 20;

            // Database configuration error screen
            if (dbError) {
                return (
                    <div style={{minHeight:'100vh',background:'#111827',display:'flex',alignItems:'center',justifyContent:'center',color:'white',padding:'2rem',textAlign:'center'}}>
                        <div>
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚ö†Ô∏è</div>
                            <h1 style={{fontSize:'1.5rem',marginBottom:'1rem'}}>Firebase Not Configured</h1>
                            <p style={{color:'#9ca3af',marginBottom:'1rem'}}>Open this HTML file and update the <code style={{background:'#374151',padding:'0.2rem 0.5rem',borderRadius:'0.25rem'}}>FIREBASE_DATABASE_URL</code> with your Firebase database URL.</p>
                            <p style={{color:'#6b7280',fontSize:'0.875rem'}}>See the setup instructions for details.</p>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div style={{minHeight:'100vh',background:'#111827',display:'flex',alignItems:'center',justifyContent:'center',color:'white'}}>
                        <div style={{textAlign:'center'}}>
                            <div style={{fontSize:'2rem',marginBottom:'1rem'}}>üèÉ</div>
                            <div>Connecting to database...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{minHeight:'100vh',background:'#111827',color:'white'}}>
                    {/* Check-In Modal */}
                    {showCheckInConfirm !== null && (
                        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:50,padding:'1rem'}}>
                            <div style={{background:'#1f2937',borderRadius:'0.75rem',padding:'1.5rem',width:'100%',maxWidth:'20rem',textAlign:'center'}}>
                                <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üìç</div>
                                <h2 style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'0.5rem'}}>Check In to {STAGES.find(s => s.id === showCheckInConfirm)?.name}?</h2>
                                <p style={{color:'#9ca3af',fontSize:'0.875rem',marginBottom:'1.5rem'}}>This will notify the team that you're ready at the exchange point.</p>
                                <div style={{display:'flex',gap:'0.75rem'}}>
                                    <button onClick={() => handleCheckIn(showCheckInConfirm)} style={{flex:1,background:'#16a34a',padding:'0.75rem',borderRadius:'0.5rem',border:'none',color:'white',cursor:'pointer',fontWeight:'600'}}>‚úì Check In</button>
                                    <button onClick={() => setShowCheckInConfirm(null)} style={{flex:1,background:'#4b5563',padding:'0.75rem',borderRadius:'0.5rem',border:'none',color:'white',cursor:'pointer',fontWeight:'600'}}>Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Login Modal */}
                    {showLoginModal && (
                        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:50,padding:'1rem'}}>
                            <div style={{background:'#1f2937',borderRadius:'0.5rem',padding:'1.5rem',width:'100%',maxWidth:'20rem'}}>
                                <h2 style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem',display:'flex',alignItems:'center',gap:'0.5rem'}}><Lock size={20}/> Admin Login</h2>
                                <input type="password" placeholder="Enter password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} style={{width:'100%',background:'#374151',borderRadius:'0.25rem',padding:'0.5rem 0.75rem',color:'white',border:'none',marginBottom:'0.75rem',fontSize:'16px'}} autoFocus/>
                                {loginError && <p style={{color:'#f87171',fontSize:'0.875rem',marginBottom:'0.75rem'}}>{loginError}</p>}
                                <div style={{display:'flex',gap:'0.5rem'}}>
                                    <button onClick={handleLogin} style={{flex:1,background:'#2563eb',padding:'0.5rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer'}}>Login</button>
                                    <button onClick={() => { setShowLoginModal(false); setPasswordInput(''); setLoginError(''); }} style={{flex:1,background:'#4b5563',padding:'0.5rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer'}}>Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div style={{background:'linear-gradient(to right, #14532d, #1e3a5f)',padding:'1rem'}}>
                        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                            <div>
                                <h1 style={{fontSize:'1.4rem',fontWeight:'bold',margin:0,display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                    üèÉ Palmdale Station B2V
                                    {connected ? <Wifi size={16} style={{color:'#4ade80'}}/> : <WifiOff size={16} style={{color:'#f87171'}}/>}
                                </h1>
                                <p style={{color:'#86efac',fontSize:'0.8rem',margin:'0.25rem 0 0'}}>Baker to Vegas 2026 ‚Ä¢ Live Sync</p>
                            </div>
                            <button onClick={() => isAdmin ? handleLogout() : setShowLoginModal(true)} style={{padding:'0.5rem 0.75rem',borderRadius:'0.5rem',display:'flex',alignItems:'center',gap:'0.5rem',fontSize:'0.8rem',border:'none',color:'white',cursor:'pointer',background:isAdmin?'#16a34a':'#374151'}}>
                                {isAdmin ? <><Unlock size={14}/> Admin</> : <><Eye size={14}/> View</>}
                            </button>
                        </div>
                        <div style={{display:'flex',justifyContent:'center',gap:'0.4rem',marginTop:'0.6rem',flexWrap:'wrap'}}>
                            <span style={{background:'rgba(30,64,175,0.5)',padding:'0.2rem 0.6rem',borderRadius:'9999px',fontSize:'0.7rem'}}>{TOTAL_DISTANCE.toFixed(1)} mi</span>
                            <span style={{background:'rgba(22,101,52,0.5)',padding:'0.2rem 0.6rem',borderRadius:'9999px',fontSize:'0.7rem'}}>{assignedCount}/{runningStages} assigned</span>
                            <span style={{background:'rgba(147,51,234,0.5)',padding:'0.2rem 0.6rem',borderRadius:'9999px',fontSize:'0.7rem',display:'flex',alignItems:'center',gap:'0.2rem'}}><UserCheck size={10}/> {checkedInCount} ready</span>
                        </div>
                        {saveStatus && <div style={{textAlign:'center',marginTop:'0.4rem',color:'#4ade80',fontSize:'0.8rem'}} className="animate-pulse">{saveStatus}</div>}
                    </div>

                    {/* Map */}
                    <div style={{position:'relative',height:'11rem',background:'#1f2937',overflow:'hidden'}}>
                        <svg viewBox="0 0 800 260" style={{width:'100%',height:'100%',background:'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)'}}>
                            <path d={STAGES.map((s, i) => { const x = 50 + ((s.lng + 116.35) / 1.2) * 700; const y = 240 - ((s.lat - 35.5) / 0.7) * 220; return `${i === 0 ? 'M' : 'L'} ${x} ${y}`; }).join(' ')} fill="none" stroke="#4a5568" strokeWidth="3" strokeDasharray="5,5"/>
                            {STAGES.map((stage) => {
                                const x = 50 + ((stage.lng + 116.35) / 1.2) * 700;
                                const y = 240 - ((stage.lat - 35.5) / 0.7) * 220;
                                const isSelected = selectedStage?.id === stage.id;
                                const hasRunner = runners[stage.id]?.name;
                                const isCheckedIn = checkIns[stage.id];
                                return (
                                    <g key={stage.id} onClick={() => setSelectedStage(stage)} style={{cursor:'pointer'}}>
                                        {isSelected && <circle cx={x} cy={y} r="15" fill={getStageColor(stage)} opacity="0.3"><animate attributeName="r" values="15;20;15" dur="1.5s" repeatCount="indefinite"/></circle>}
                                        <circle cx={x} cy={y} r={isSelected ? 10 : 6} fill={isCheckedIn ? '#10B981' : getStageColor(stage)} stroke={hasRunner ? '#10B981' : '#fff'} strokeWidth={hasRunner ? 2 : 1}/>
                                        <text x={x} y={y + 1} textAnchor="middle" dominantBaseline="middle" fill="white" fontSize={isSelected ? 8 : 5} fontWeight="bold">{stage.id === 0 ? '‚úì' : stage.id === 21 ? 'üèÅ' : isCheckedIn ? '‚úì' : stage.id}</text>
                                    </g>
                                );
                            })}
                            <text x="55" y="16" fill="#9CA3AF" fontSize="8">Baker</text>
                            <text x="720" y="40" fill="#9CA3AF" fontSize="8">Vegas</text>
                        </svg>
                        <div style={{position:'absolute',bottom:'0.3rem',left:'0.3rem',background:'rgba(17,24,39,0.85)',padding:'0.3rem',borderRadius:'0.2rem',fontSize:'0.55rem'}}>
                            <div style={{display:'flex',alignItems:'center',gap:'0.25rem',marginBottom:'0.1rem'}}><div style={{width:'0.4rem',height:'0.4rem',borderRadius:'50%',background:'#3B82F6'}}></div><span>&lt;6</span></div>
                            <div style={{display:'flex',alignItems:'center',gap:'0.25rem',marginBottom:'0.1rem'}}><div style={{width:'0.4rem',height:'0.4rem',borderRadius:'50%',background:'#F59E0B'}}></div><span>6-8</span></div>
                            <div style={{display:'flex',alignItems:'center',gap:'0.25rem',marginBottom:'0.1rem'}}><div style={{width:'0.4rem',height:'0.4rem',borderRadius:'50%',background:'#EF4444'}}></div><span>&gt;8</span></div>
                            <div style={{display:'flex',alignItems:'center',gap:'0.25rem'}}><div style={{width:'0.4rem',height:'0.4rem',borderRadius:'50%',background:'#10B981'}}></div><span>Ready</span></div>
                        </div>
                    </div>

                    {/* List Toggle */}
                    <button onClick={() => setShowList(!showList)} style={{width:'100%',background:'#1f2937',padding:'0.7rem 1rem',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid #374151',border:'none',color:'white',cursor:'pointer'}}>
                        <span style={{fontWeight:'600',fontSize:'0.95rem'}}>Stages & Assignments</span>
                        {showList ? <ChevronUp size={18}/> : <ChevronDown size={18}/>}
                    </button>

                    {/* Stage List */}
                    {showList && (
                        <div style={{paddingBottom:'5rem'}}>
                            {STAGES.map((stage) => {
                                const isCheckedIn = checkIns[stage.id];
                                const hasRunner = runners[stage.id]?.name;
                                return (
                                    <div key={stage.id} style={{borderBottom:'1px solid #374151',background:selectedStage?.id === stage.id ? '#1f2937' : '#111827'}}>
                                        <div style={{padding:'0.8rem',cursor:'pointer'}} onClick={() => setSelectedStage(selectedStage?.id === stage.id ? null : stage)}>
                                            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                                                <div style={{display:'flex',alignItems:'center',gap:'0.6rem'}}>
                                                    <div style={{position:'relative'}}>
                                                        <div style={{width:'2.1rem',height:'2.1rem',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'bold',fontSize:'0.75rem',background:isCheckedIn?'#10B981':getStageColor(stage)}}>
                                                            {stage.id === 0 ? '‚úì' : stage.id === 21 ? 'üèÅ' : isCheckedIn ? '‚úì' : stage.id}
                                                        </div>
                                                        {isCheckedIn && <div style={{position:'absolute',bottom:'-2px',right:'-2px',background:'#a855f7',borderRadius:'50%',width:'12px',height:'12px',display:'flex',alignItems:'center',justifyContent:'center'}}><Clock size={7}/></div>}
                                                    </div>
                                                    <div>
                                                        <div style={{fontWeight:'600',fontSize:'0.9rem',display:'flex',alignItems:'center',gap:'0.35rem'}}>
                                                            {stage.name}
                                                            {isCheckedIn && <span style={{fontSize:'0.55rem',background:'#7c3aed',padding:'0.1rem 0.3rem',borderRadius:'9999px'}}>READY</span>}
                                                        </div>
                                                        <div style={{fontSize:'0.75rem',color:'#9ca3af'}}>
                                                            {stage.distance > 0 ? `${stage.distance} mi` : stage.id === 0 ? 'Check-in' : 'Finish'}
                                                            {isCheckedIn && <span style={{color:'#a78bfa'}}> ‚Ä¢ {formatTime(isCheckedIn.time)}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                {hasRunner ? (
                                                    <div style={{textAlign:'right'}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:'0.2rem',color:'#4ade80',fontSize:'0.85rem'}}><User size={13}/><span style={{fontWeight:'500'}}>{runners[stage.id].name}</span></div>
                                                        {runners[stage.id].notes && <div style={{fontSize:'0.65rem',color:'#9ca3af',maxWidth:'6rem',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{runners[stage.id].notes}</div>}
                                                    </div>
                                                ) : <div style={{color:'#6b7280',fontSize:'0.75rem'}}>Not assigned</div>}
                                            </div>
                                        </div>

                                        {selectedStage?.id === stage.id && (
                                            <div style={{padding:'0 0.8rem 0.8rem',background:'rgba(31,41,55,0.5)'}}>
                                                <p style={{fontSize:'0.75rem',color:'#d1d5db',marginBottom:'0.5rem'}}>{stage.description}</p>
                                                <div style={{fontSize:'0.65rem',color:'#9ca3af',marginBottom:'0.5rem'}}>GPS: {stage.lat.toFixed(5)}¬∞N, {Math.abs(stage.lng).toFixed(5)}¬∞W</div>

                                                {/* Check-In Button */}
                                                {hasRunner && stage.id > 0 && stage.id < 21 && (
                                                    <div style={{marginBottom:'0.5rem'}}>
                                                        {isCheckedIn ? (
                                                            <div style={{display:'flex',alignItems:'center',gap:'0.4rem'}}>
                                                                <div style={{flex:1,background:'#065f46',padding:'0.55rem',borderRadius:'0.4rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.35rem',fontSize:'0.8rem'}}>
                                                                    <CheckCircle size={16}/><span style={{fontWeight:'600'}}>Checked In @ {formatTime(isCheckedIn.time)}</span>
                                                                </div>
                                                                <button onClick={() => handleUndoCheckIn(stage.id)} style={{background:'#4b5563',padding:'0.55rem 0.7rem',borderRadius:'0.4rem',border:'none',color:'white',cursor:'pointer',fontSize:'0.75rem'}}>Undo</button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => setShowCheckInConfirm(stage.id)} style={{width:'100%',background:'linear-gradient(to right, #7c3aed, #2563eb)',padding:'0.65rem',borderRadius:'0.4rem',border:'none',color:'white',cursor:'pointer',fontWeight:'600',fontSize:'0.9rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.35rem'}}>
                                                                <MapPin size={16}/> Check In - I'm Ready
                                                            </button>
                                                        )}
                                                    </div>
                                                )}

                                                {isAdmin && editingStage === stage.id ? (
                                                    <div>
                                                        <input type="text" placeholder="Runner name" value={editName} onChange={(e) => setEditName(e.target.value)} style={{width:'100%',background:'#374151',borderRadius:'0.25rem',padding:'0.45rem 0.65rem',color:'white',border:'none',marginBottom:'0.4rem',fontSize:'16px'}} autoFocus/>
                                                        <input type="text" placeholder="Notes (pace, phone)" value={editNotes} onChange={(e) => setEditNotes(e.target.value)} style={{width:'100%',background:'#374151',borderRadius:'0.25rem',padding:'0.45rem 0.65rem',color:'white',border:'none',marginBottom:'0.4rem',fontSize:'16px'}}/>
                                                        <div style={{display:'flex',gap:'0.4rem'}}>
                                                            <button onClick={() => handleSaveRunner(stage.id)} style={{flex:1,background:'#16a34a',padding:'0.45rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.25rem',fontSize:'0.8rem'}}><Check size={14}/> Save</button>
                                                            <button onClick={() => { setEditingStage(null); setEditName(''); setEditNotes(''); }} style={{flex:1,background:'#4b5563',padding:'0.45rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.25rem',fontSize:'0.8rem'}}><X size={14}/> Cancel</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div style={{display:'flex',gap:'0.4rem'}}>
                                                        {isAdmin && (
                                                            <>
                                                                <button onClick={() => startEdit(stage)} style={{flex:1,background:'#2563eb',padding:'0.45rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.25rem',fontSize:'0.8rem'}}><Edit2 size={13}/> {hasRunner ? 'Edit' : 'Assign'}</button>
                                                                {hasRunner && <button onClick={() => handleClearRunner(stage.id)} style={{background:'#dc2626',padding:'0.45rem 0.65rem',borderRadius:'0.25rem',border:'none',color:'white',cursor:'pointer',fontSize:'0.8rem'}}>Clear</button>}
                                                            </>
                                                        )}
                                                        <a href={`https://www.google.com/maps/search/?api=1&query=${stage.lat},${stage.lng}`} target="_blank" rel="noopener noreferrer" style={{background:'#4b5563',padding:'0.45rem 0.65rem',borderRadius:'0.25rem',color:'white',textDecoration:'none',display:'flex',alignItems:'center',gap:'0.2rem',fontSize:'0.8rem'}}><Navigation size={13}/> Map</a>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Footer */}
                    <div style={{position:'fixed',bottom:0,left:0,right:0,background:'#1f2937',borderTop:'1px solid #374151',padding:'0.45rem'}}>
                        <div style={{display:'flex',justifyContent:'space-around',textAlign:'center',fontSize:'0.65rem'}}>
                            <div><div style={{fontSize:'1rem',fontWeight:'bold',color:'#60a5fa'}}>{runningStages}</div><div style={{color:'#9ca3af'}}>Stages</div></div>
                            <div><div style={{fontSize:'1rem',fontWeight:'bold',color:'#fbbf24'}}>{TOTAL_DISTANCE.toFixed(1)}</div><div style={{color:'#9ca3af'}}>Miles</div></div>
                            <div><div style={{fontSize:'1rem',fontWeight:'bold',color:'#4ade80'}}>{assignedCount}</div><div style={{color:'#9ca3af'}}>Assigned</div></div>
                            <div><div style={{fontSize:'1rem',fontWeight:'bold',color:'#a78bfa'}}>{checkedInCount}</div><div style={{color:'#9ca3af'}}>Ready</div></div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App/>, document.getElementById('root'));
    </script>
</body>
</html>
